name: Terragrunt Pipeline (Basic Auth via Azure CLI)

on:
  push:
    branches:
      - main

permissions:
  contents: read  # No OIDC needed

jobs:
  terragrunt-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Azure CLI login using Service Principal
      - name: Azure CLI login
        run: |
          echo "Logging in to Azure..."
          az login --service-principal \
                   --username ${{ secrets.AZURE_CLIENT_ID }} \
                   --password ${{ secrets.AZURE_CLIENT_SECRET }} \
                   --tenant ${{ secrets.AZURE_TENANT_ID }}
          echo "Azure login successful"

      # Step 3: Install Terraform
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # Step 4: Install Terragrunt
      - name: Install Terragrunt
        run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/

      # Step 5: Terragrunt Format
      - name: Terragrunt Format
        working-directory: app1/dev
        run: terragrunt run-all fmt -check=false

      # Step 6: Terragrunt Init
      - name: Terragrunt Init
        working-directory: app1/dev
        run: terragrunt run-all init --terragrunt-non-interactive

      # Step 7: Terragrunt Plan
      - name: Terragrunt Plan
        working-directory: app1/dev
        run: terragrunt run-all plan --terragrunt-non-interactive

      # Step 8: Terragrunt Apply
      - name: Terragrunt Apply
        working-directory: app1/dev
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve
