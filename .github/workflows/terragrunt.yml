name: Terragrunt Pipeline

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      app:
        description: "Application name"
        required: true
        type: choice
        options: [all, app1, app2]
        default: all

      environment:
        description: "Environment"
        required: true
        type: choice
        options: [all, dev, test, prod]
        default: all

      action:
        description: "Action to perform"
        required: true
        type: choice
        options: [plan, apply]

permissions:
  id-token: write
  contents: read

################################
# 1️⃣ Detect Changes
################################
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      nonprod_matrix: ${{ steps.set-matrix.outputs.nonprod_matrix }}
      prod_matrix: ${{ steps.set-matrix.outputs.prod_matrix }}
      full_matrix: ${{ steps.set-matrix.outputs.full_matrix }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build matrix
        id: set-matrix
        run: |
          set -euo pipefail

          ALL_MATRIX=$(
            find . -maxdepth 2 -mindepth 2 -type d \
            | grep -v '^./modules' \
            | sed 's|^\./||' \
            | awk -F/ '{print "{\"app\":\""$1"\",\"env\":\""$2"\"}"}' \
            | jq -cs .
          )

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FILTERED=$(echo "$ALL_MATRIX" | jq -c \
              --arg app "${{ inputs.app }}" \
              --arg env "${{ inputs.environment }}" '
              map(select(
                ($app == "all" or .app == $app) and
                ($env == "all" or .env == $env)
              ))')
          else
            FILTERED=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" \
              | awk -F/ 'NF>=2 {print "{\"app\":\""$1"\",\"env\":\""$2"\"}"}' \
              | sort -u | jq -cs .)
          fi

          NONPROD=$(echo "$FILTERED" | jq -c '[.[] | select(.env != "prod")]')
          PROD=$(echo "$FILTERED" | jq -c '[.[] | select(.env == "prod")]')

          echo "nonprod_matrix=$(jq -c --argjson a "$NONPROD" -n '{include:$a}')" >> $GITHUB_OUTPUT
          echo "prod_matrix=$(jq -c --argjson a "$PROD" -n '{include:$a}')" >> $GITHUB_OUTPUT
          echo "full_matrix=$(jq -c --argjson a "$FILTERED" -n '{include:$a}')" >> $GITHUB_OUTPUT

################################
# 2️⃣ PLAN (SAFE ON PUSH)
################################
  terragrunt-plan:
    needs: detect-changes
    if: needs.detect-changes.outputs.full_matrix != '{"include":[]}'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.full_matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Plan
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all plan --terragrunt-non-interactive

################################
# 3️⃣ APPLY (ONLY MANUAL + NON-PROD)
################################
  terragrunt-apply:
    needs:
      - terragrunt-plan
      - detect-changes
    if: >
      github.event_name == 'workflow_dispatch' &&
      inputs.action == 'apply' &&
      needs.detect-changes.outputs.nonprod_matrix != '{"include":[]}'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.nonprod_matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Apply
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve