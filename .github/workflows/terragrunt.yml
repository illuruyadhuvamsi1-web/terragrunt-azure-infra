
name: Terragrunt Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  # =========================================================
  # 1️⃣ Detect changed app/env → outputs 3 matrices + a flag
  #    - nonprod_matrix (env not protected)
  #    - prod_matrix    (env protected)
  #    - full_matrix    (all changed app/env)
  #    - protected_present (true/false)
  # =========================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      nonprod_matrix: ${{ steps.set-matrix.outputs.nonprod_matrix }}
      prod_matrix: ${{ steps.set-matrix.outputs.prod_matrix }}
      full_matrix: ${{ steps.set-matrix.outputs.full_matrix }}
      protected_present: ${{ steps.set-matrix.outputs.protected_present }}

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build matrices dynamically
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # ------------------------------------
          # CONFIG: Protected environments (require approval)
          # Add more like ("prod" "stage") if needed
          PROTECTED_ENVS=("prod")

          # ------------------------------------
          # Helpers
          emit_all() {
            local NONPROD="$1"; local PROD="$2"; local FULL="$3"; local HAS_PROT="$4"
            printf 'nonprod_matrix=%s\n' "$NONPROD" >> "$GITHUB_OUTPUT"
            printf 'prod_matrix=%s\n' "$PROD"     >> "$GITHUB_OUTPUT"
            printf 'full_matrix=%s\n' "$FULL"     >> "$GITHUB_OUTPUT"
            printf 'protected_present=%s\n' "$HAS_PROT" >> "$GITHUB_OUTPUT"
          }

          wrap_include() {
            local -n arr_ref=$1
            if [ ${#arr_ref[@]} -eq 0 ]; then
              jq -c -n '{include: []}'
            else
              printf '%s\n' "${arr_ref[@]}" | jq -cs '{include: .}'
            fi
          }

          in_list() {
            local needle="$1"; shift || true
            for x in "$@"; do [[ "$x" == "$needle" ]] && return 0; done
            return 1
          }

          is_protected() {
            local env="$1"
            for p in "${PROTECTED_ENVS[@]}"; do [[ "$env" == "$p" ]] && return 0; done
            return 1
          }

          # ------------------------------------
          # Discover apps and env folders
          mapfile -t APPS < <(find . -maxdepth 1 -type d -name "app*" -printf '%f\n' | sort)

          declare -A APP_ENVS
          UNION_ENVS=()
          for app in "${APPS[@]}"; do
            mapfile -t ENVS < <(find "$app" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' | sort)
            APP_ENVS["$app"]="${ENVS[*]}"
            for e in "${ENVS[@]}"; do
              in_list "$e" "${UNION_ENVS[@]}" || UNION_ENVS+=("$e")
            done
          done

          # ------------------------------------
          # Build ALL_* (manual trigger / first commit)
          ALL_FULL_ITEMS=()
          ALL_NONPROD_ITEMS=()
          ALL_PROD_ITEMS=()

          for app in "${APPS[@]}"; do
            # shellcheck disable=SC2206
            for env in ${APP_ENVS["$app"]}; do
              item=$(jq -c -n --arg app "$app" --arg env "$env" '{app:$app,env:$env}')
              ALL_FULL_ITEMS+=("$item")
              if is_protected "$env"; then
                ALL_PROD_ITEMS+=("$item")
              else
                ALL_NONPROD_ITEMS+=("$item")
              fi
            done
          done

          ALL_FULL=$(wrap_include ALL_FULL_ITEMS)
          ALL_NONPROD=$(wrap_include ALL_NONPROD_ITEMS)
          ALL_PROD=$(wrap_include ALL_PROD_ITEMS)
          HAS_PROTECTED_ALL=$( [ ${#ALL_PROD_ITEMS[@]} -gt 0 ] && echo true || echo false )

          # ------------------------------------
          # Fallbacks: manual trigger / first commit → deploy everything
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            emit_all "$ALL_NONPROD" "$ALL_PROD" "$ALL_FULL" "$HAS_PROTECTED_ALL"
            exit 0
          fi

          if [ -z "${{ github.event.before }}" ]; then
            emit_all "$ALL_NONPROD" "$ALL_PROD" "$ALL_FULL" "$HAS_PROTECTED_ALL"
            exit 0
          fi

          # ------------------------------------
          # Diff changed files between commits
          CHANGED=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}")

          MATRIX_ITEMS=()
          while IFS= read -r file; do
            IFS='/' read -r top second _rest <<< "$file" || true
            [[ -z "${top:-}" || -z "${second:-}" ]] && continue
            in_list "$top"    "${APPS[@]}"       || continue
            in_list "$second" "${UNION_ENVS[@]}" || continue
            item=$(jq -c -n --arg app "$top" --arg env "$second" '{app:$app,env:$env}')
            MATRIX_ITEMS+=("$item")
          done <<< "$CHANGED"

          # Deduplicate and make arrays
          if [ ${#MATRIX_ITEMS[@]} -eq 0 ]; then
            MATRIX_JSON='[]'
          else
            MATRIX_JSON=$(printf '%s\n' "${MATRIX_ITEMS[@]}" | sort -u | jq -cs '.')
          fi

          # Split dynamic matrix into protected vs non-protected using jq
          if [ ${#PROTECTED_ENVS[@]} -gt 0 ]; then
            jq_protected=$(printf '"%s",' "${PROTECTED_ENVS[@]}")
            jq_protected="[${jq_protected%,}]"
          else
            jq_protected="[]"
          fi

          PROTECTED_JSON=$(echo "$MATRIX_JSON" | jq -c --argjson prot "$jq_protected" \
            '[.[] | select(.env as $e | $prot | index($e))]')
          NONPROD_JSON=$(echo "$MATRIX_JSON" | jq -c --argjson prot "$jq_protected" \
            '[.[] | select(.env as $e | ($prot | index($e)) | not)]')

          NONPROD_WRAPPED=$(jq -c --argjson arr "$NONPROD_JSON" -n '{include: $arr}')
          PROD_WRAPPED=$(jq -c --argjson arr "$PROTECTED_JSON" -n '{include: $arr}')
          FULL_WRAPPED=$(jq -c --argjson arr "$MATRIX_JSON" -n '{include: $arr}')
          HAS_PROTECTED=$( [ "$(echo "$PROTECTED_JSON" | jq 'length')" -gt 0 ] && echo true || echo false )

          emit_all "$NONPROD_WRAPPED" "$PROD_WRAPPED" "$FULL_WRAPPED" "$HAS_PROTECTED"

  # =========================================================
  # 2️⃣ Terragrunt PLAN (full output in summary) — for all changed envs
  # =========================================================
  terragrunt-plan:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.full_matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set ARM env vars
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Terragrunt
        run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all init --terragrunt-non-interactive

      - name: Terragrunt Plan
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: |
          terragrunt run-all plan \
            --terragrunt-non-interactive \
            -no-color | tee plan.txt

      - name: Publish Plan to Summary
        if: always()
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: |
          {
            echo "## Terraform Plan"
            echo ""
            echo "**App:** ${{ matrix.app }} | **Env:** ${{ matrix.env }}"
            echo ""
            echo '```terraform'
            cat plan.txt
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

  # =========================================================
  # 3️⃣ Manual Approval (PROTECTED envs ONLY) — sits BETWEEN plan and prod apply
  # =========================================================
  manual-approval-prod:
    needs:
      - terragrunt-plan
      - detect-changes
    runs-on: ubuntu-latest

    # Trigger only if any protected envs are present in changes
    if: needs.detect-changes.outputs.protected_present == 'true'

    # Gate via GitHub Environment 'prod' (configure required reviewers in repo settings)
    environment:
      name: prod

    steps:
      - name: Awaiting approval for protected environments
        run: echo "Approved. Proceeding with protected env apply."

  # =========================================================
  # 4️⃣ Terragrunt APPLY (NON-PROTECTED) — runs immediately after plan
  # =========================================================
  terragrunt-apply-nonprod:
    needs:
      - terragrunt-plan
      - detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.nonprod_matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set ARM env vars
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Terragrunt
        run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Apply (Non-Protected)
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve

  # =========================================================
  # 5️⃣ Terragrunt APPLY (PROTECTED) — runs AFTER approval
  # =========================================================
  terragrunt-apply-prod:
    needs:
      - manual-approval-prod
      - terragrunt-plan
      - detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.prod_matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set ARM env vars
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Terragrunt
        run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Apply (Protected)
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve