name: Terragrunt Pipeline

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      app:
        description: "Application name (app1 / app2 / all)"
        required: true
        default: "all"

      environment:
        description: "Environment (dev / test / prod / all)"
        required: true
        default: "all"

      action:
        description: "Action to perform"
        required: true
        type: choice
        options: [plan, apply]

permissions:
  id-token: write
  contents: read

########################################
# 1️⃣ Detect changes OR use user inputs
########################################
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      nonprod_matrix: ${{ steps.set-matrix.outputs.nonprod_matrix }}
      prod_matrix: ${{ steps.set-matrix.outputs.prod_matrix }}
      full_matrix: ${{ steps.set-matrix.outputs.full_matrix }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Discover all app/env combos
          ALL_MATRIX=$(
            find . -maxdepth 2 -mindepth 2 -type d \
            | grep -v '^./modules' \
            | sed 's|^\./||' \
            | awk -F/ '{print "{\"app\":\""$1"\",\"env\":\""$2"\"}"}' \
            | jq -cs .
          )

          # ------------------------------
          # MANUAL RUN (workflow_dispatch)
          # ------------------------------
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            APP="${{ inputs.app }}"
            ENV="${{ inputs.environment }}"

            FILTERED=$(echo "$ALL_MATRIX" | jq -c \
              --arg app "$APP" \
              --arg env "$ENV" '
                map(
                  select(
                    ($app == "all" or .app == $app) and
                    ($env == "all" or .env == $env)
                  )
                )
              ')

          # ------------------------------
          # PUSH RUN (auto detect changes)
          # ------------------------------
          else
            CHANGED=$(
              git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" \
              | grep -vE '^\.github/' \
              || true
            )

            FILTERED=$(echo "$CHANGED" | awk -F/ '
              NF>=2 {print "{\"app\":\""$1"\",\"env\":\""$2"\"}"}
            ' | sort -u | jq -cs .)

          fi

          NONPROD=$(echo "$FILTERED" | jq -c '[.[] | select(.env != "prod")]')
          PROD=$(echo "$FILTERED" | jq -c '[.[] | select(.env == "prod")]')

          echo "nonprod_matrix=$(jq -c --argjson a "$NONPROD" -n '{include:$a}')" >> $GITHUB_OUTPUT
          echo "prod_matrix=$(jq -c --argjson a "$PROD" -n '{include:$a}')" >> $GITHUB_OUTPUT
          echo "full_matrix=$(jq -c --argjson a "$FILTERED" -n '{include:$a}')" >> $GITHUB_OUTPUT

########################################
# 2️⃣ VALIDATE (ALL SELECTED ENVS)
########################################
  terragrunt-validate:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.full_matrix) }}

    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all init --terragrunt-non-interactive

      - name: Terragrunt Validate
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all validate-inputs --terragrunt-non-interactive

########################################
# 3️⃣ PLAN (ALL)
########################################
  terragrunt-plan:
    needs: [detect-changes, terragrunt-validate]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.full_matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Plan
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all plan --terragrunt-non-interactive -no-color

########################################
# 4️⃣ APPLY (ONLY WHEN MANUAL + apply)
########################################
  terragrunt-apply:
    needs: 
      - terragrunt-plan
      - detect-changes
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apply'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.nonprod_matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - run: |
          curl -Lo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.8/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt Apply (Non-Prod)
        working-directory: ${{ matrix.app }}/${{ matrix.env }}
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve